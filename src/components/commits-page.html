<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="commits-page">

    <template>
        <form>
            <label class="ms-fontWeight-semibold">Commits graph</label>
            <div class="ms-TextField">
                <label class="ms-Label">Repository URL</label>
                <input  id="repositoryURL" value="{{repo::input}}" class="ms-TextField-field">
            </div>
            <div>
                <label class="ms-Label">Weekday or Week</label>
                <select id="mode" on-change="modeChange">
                    <option value="weekday">Weekday</option>
                    <option value="week">Week</option>
                </select>
            </div>
            <template is="dom-if" if="{{showChartType}}">
                <label class="ms-Label">Chart Type</label>
                <select id="chartType">
                    <option value="bar">Bar</option>
                    <option value="line">Line</option>
                </select>
            </template>
            <button-pair></button-pair>
        </form>
    </template>

    <script>
        Polymer({
            is: "commits-page",
            listeners: {
                "button-pair-insert": "insert"
            },
            properties: {
                repo: {
                    type: String,
                    notify: true
                },
                showChartType: {
                    type: Boolean,
                    value: false
                }
            },
            insert: function() {
                var url = this.$.repositoryURL.value;
                var owner = url.split("/")[0];
                var repo = url.split("/")[1];
                var chartType = this.$$("#chartType").value

				// Make sure the URL is filled in.
				if (!url) {
                    this.fire("showErrorMessage", {text: "Please enter URL."})
                    return
                }
                // Check for valid owner.
                if (!owner) {
                    this.fire("showErrorMessage", {text: "Invalid owner."})
                    return
                }
                // Check for valid repo.
                if (!repo) {
                    this.fire("showErrorMessage", {text: "Invalid repo."})
                    return
                }
                // graph of commits by weekday
				if (this.$.mode.value == "weekday") {
                    var self = this;
					github.commit_activity(owner, repo, function(response) {
						chart.weekdayCommits(repo, response, function(base64Image) {
							insertData(base64Image.replace("data:image/png;base64,",""), "image");
						})
					}, function() {
                        this.fire("showErrorMessage", {text: "Connection Failed.<br>Please check your internet connection"})
                    });
				}
                // graph of commits by week
				else {
					github.participation(owner, repo, function(response) {
						chart.participation(repo, response, chartType, function(base64Image) {
                            insertData(base64Image.replace("data:image/png;base64,",""), "image");
                        })
					}, function() {
                        this.fire("showErrorMessage", {text: "Connection Failed."});
                    });
				}
            },
            modeChange: function() {
                this.showChartType = this.$.mode.value == "week"
            }
        });
    </script>

</dom-module>