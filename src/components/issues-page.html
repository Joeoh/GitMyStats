<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="issues-page">

    <template>
        <form id="form">
            <label class="ms-fontWeight-semibold">Issues</label>
            <div class="ms-TextField">
                <label class="ms-Label">Repository URL</label>
                <input  id="repositoryURL" value="{{repo::input}}" class="ms-TextField-field">
            </div>
            <div class="ms-TextField">
                <label class="ms-Label">Start Date</label>
                <input  id="startDate" type = "date" placeholder="DD/MM/YYYY" class="ms-TextField-field">
            </div>
            <div class="ms-TextField">
                <label class="ms-Label">End Date</label>
                <input  id="endDate" type = "date" placeholder="DD/MM/YYYY" class="ms-TextField-field">
            </div>
            <div>
                <label class="ms-Label">Opened/Closed</label>
                <select id = "mode" name="contributionType">
                    <option value="open">Open</option>
                    <option value="closed">Closed</option>
                </select>
            </div>
            <div>
                <label class="ms-Label">Users</label>
                <select id = "userSelect" name="userSelect">
                    <option value="combined">All users</option>
                    <option value="singleUser">Single User</option>
                </select>
            </div>
            <div>
                <input  id="selectedUser" placeholder="eg, joeoh" class="ms-TextField-field">
            </div>
            <button-pair></button-pair>
        </form>
    </template>

    <script>
        Polymer({
            is: "issues-page",
            // Set default values for date inputs.
            ready: function() {
                var now = new Date()
                this.$.endDate.valueAsDate = now
                this.$.startDate.valueAsDate = new Date().setFullYear(now.getFullYear() - 1)
            },
            listeners: {
                "button-pair-insert": "insert"
            },
            insert: function() {

                var url = this.$.repositoryURL.value
                var owner = url.split("/")[0]
                var repo = url.split("/")[1]
                var unixStartDate = new Date(this.$.startDate.value).getTime() / 1000
                var unixEndDate = new Date(this.$.endDate.value).getTime() / 1000
                var mode = this.$.mode.value
                var title = this.$.mode[this.$.mode.selectedIndex].text
                var singleUser = this.$.userSelect.value == "singleUser"
                var selectedUser = singleUser ? this.$$("#selectedUser").value : null
                var url = this.$.repositoryURL.value

                console.log("!url: " + !url)
                console.log(url)
                var startDate = this.$.startDate.value
                console.log(startDate)
                var endDate = this.$.endDate.value
                console.log(endDate)
                var mode = this.$.mode.value
                console.log(mode)
                //singleUser is boolean true if dropdown selection is singleUser
                // otherwise calculate graph for all users
                var singleUser = this.$.userSelect.value == "singleUser"
                console.log(singleUser)
                var selectedUser = this.$.selectedUser.value
                console.log(selectedUser)

                // Make sure the fields are filled in correctly.
                if (!url) {
                    this.fire("showErrorMessage", {text: "Please enter a URL."});
                    return;
                }
                if (!startDate) {
                    this.fire("showErrorMessage", {text: "Invalid Start Date.<br>Please enter another date."});
                    return;
                }
                if (!endDate) {
                    this.fire("showErrorMessage", {text: "Invalid End Date.<br>Please enter another date."});
                    return;
                }
				if (singleUser && !selectedUser) {
					this.fire("showErrorMessage", {text: "Please enter a username in the 'Users' field <br>or select 'All Users' from the dropdown"});
                    return;
                }
				console.log("time to isnert a graph")

                //mode is whether combined/opened/closed
                var state = 0;
                if(mode == "closed")
                    state = -1;
                else if(mode == "open")
                    state = 1;
                console.log("State = " + state)
                var insertString = "";
                github.issues(owner, repo, state, null, null, function(response) {
                    for (var key in response) {
                        if (response.hasOwnProperty(key)) {
                            var issueCreated = response[key].created_at;
                            var inDateRange = (unixStartDate <= issueCreated) && ( issueCreated <= unixEndDate);
                            var correctUser = (!singleUser) || selectedUser == response[key].user.login;
                            if (inDateRange && correctUser) {
                                //console.log(key, response[key]);
                                insertString += "Title : " + response[key].title + "\n";
                                insertString += "Description : " + response[key].body + "\n";
                                insertString += "Created at : " + response[key].created_at + "\n";
                                insertString += "Created by : " + response[key].user.login + "\n";
                                if (response[key].assignee != null)
                                    insertString += "Assigned to : " + response[key].assignee.login + "\n";
                                insertString += " \n \n";
                            }
                        }
                    }
                    insertData(insertString, "text");
                    //console.log(insertString);
                }, function() {
                    this.fire("showErrorMessage", {text: "Connection Failed.<br>Please check your internet connection."})
                })

                        //I've been using the following code as an example to work from, not actually used here! :)
                /*
                github.contributors(owner, repo, unixStartDate, unixEndDate, selectedUser, function(response) {
                    var points = github.contributionsPerWeek(response, mode)
                    chart.contributors(title, points, function(base64Image) {
                        insertData(base64Image.replace("data:image/png;base64,",""), "image");
                    })
                }, function() {
                    this.fire("showErrorMessage", {text: "Connection Failed.<br>Please check your internet connection."})
                });
                */
            }
        });
    </script>

</dom-module>